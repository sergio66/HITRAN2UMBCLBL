GASES 3-42 : Contents
---------------------
1) Running eg clust_runXtopts_savegasN_file.m :
   multiple steps such as
     edit freq_boundaries.m to set output dir name for gas gid
     edit and run loop_filelist_gN.m to make the output dirs for all gases,
       and list of gid/chunk/toffset to be made .. see gN_ir_list2.txt
     submit job using    sbatch --array=1-2800%128 --output='/dev/null' sergio_matlab_chip_makegas3_42.sbatch 1
     check progress of individual gases using                         filelist_gN.m                  to see which fles of gis still need to be done
     when happy with what you see, and jobs have ended, run           loop_filelist_gN_missing.m     to remove empty files
     
GASES 51-81 : Contents
----------------------
1)

COMMON
-------

MISC
----

If you have just cloned UMBC_LBL and HITRAN2UMBCLBL, make sure you
  mkdir /home/sergio/git/UMBC_LBL/IPFILES
since the profile files are written there

Also edit
  addpath0.m
since it does this
  addpath /home/sergio/SPECTRA
  addpath /home/sergio/git/matlabcode/matlibSergio/matlib/science
  addpath /home/sergio/git/matlabcode/matlibSergio/matlib/aslutil

Also edit
  cder_home.m
since it does this  
  %cd /home/sergio/HITRAN2UMBCLBL/MAKEIR/H2016/MAKEIR_ALL_H16/
  %cd /home/sergio/HITRAN2UMBCLBL/MAKEIR/H2020/MAKEIR_ALL_H20/
  cd /home/sergio/HITRAN2UMBCLBL/MAKEIR/H2024/MAKEIR_ALL_H24/

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
GASES 3-42

1) Running eg clust_runXtopts_savegasN_file.m
-----------------------------------------------

1) Set 2024 dirnames in freq_boundaries.m    this does 605-2830 cm-1
Edit it so we are putting data into
  /umbc/rs/pi_sergio/WorkDirDec2025/H2024_RUN8_NIRDATABASE/IR_605_2830/g' numstr(gid) '.dat'

2) <<< loop_filelist_gN.m   --->>> this make the original list gN_ir_list0.txt >>>

Before you start, since this is for H2024,
  then ('to keep a copy of H2020 list, now do eg  cp -a gN_ir_list.txt gN_ir_list2020.txt');

edit and run this file.
(a) first check the files to make sure they call       cder_home    instead of
  %cd /home/sergio/HITRAN2UMBCLBL/MAKEIR/H2016/MAKEIR_ALL_H16/
  %cd /home/sergio/HITRAN2UMBCLBL/MAKEIR/H2020/MAKEIR_ALL_H20/
  cd /home/sergio/HITRAN2UMBCLBL/MAKEIR/H2024/MAKEIR_ALL_H24/
Always answer -1 to the question
    gids = input('Enter gasID list (or -1 to prompt for start/stop gasID, typically [3 49] since gid2 (CO2) made by LBLRTM ) : ');
Always answer [3 49] to the question
    iA = input('Enter Start and Stop gasIDs : ');
so it is trying to make about 47 gases. We use LBLRTM to make CO2 and CH4 so we skip gasID 2,
and technically can skip CH4 but the code runs fast on multiple processors    
(b) then you have already edited "freq_boundaries.m" so it knows where the output dirs should be [dirout]. So now set
      iMakeOoutputDirs = +1
    and it will make all output dirs [dirout /g' num2str(gid) '.dat']  if they don't already exisst
      /umbc/rs/pi_sergio/WorkDirDec2025/H2024_RUN8_NIRDATABASE/IR_605_2830/g' numstr(gid) '.dat'      
(c) then it enters main loop, going over gases --> 605:25:2830 to see which chunks need to be made
    An encoded text list which is about 25000 entries long, 40 gasIDs x 90 freqchunk x 11 Toffsets to be done
    (47*90*11 = 46530 but since it is always reading the HITRAN database for each gas and figuring out if there lines for
    gas GID at chunk WNUM, it says some gases/chunks need not be done
(d) the list is saved into gN_ir_list2.txt
      cp gN_ir_list2.txt gN_ir_list.txt'  and you are ready to put jobs on cluster

      X is the number of files to be made here (cat gN_ir_list2.txt | wc -l)
        sbatch --array=1-X%128 --output='/dev/null' sergio_matlab_chip_makegas3_42.sbatch    ----->>>> USE THIS OPTION else cluster hangs

THERE ARE 25179 files in here!!!!

3) Use the HPC cluster to run sergio_matlab_makegas3_42.sbatch
    sbatch --array=1-2800%128 --output='/dev/null' sergio_matlab_chip_makegas3_42.sbatch 1      is a bit much
  So have to do
    sbatch --array=1-2000%128 --output='/dev/null' sergio_matlab_chip_makegas3_42.sbatch 1
  Note you need   /dev/null else you kill the cluster     
  Then run        loop_filelist_gN_missing.m
  which alls      write_out_jobsnotdone_for_cluster.m
  and writes out  jobs_not_done.sc
  which is a much smaller list of jobs to be done, that can be put on cluster and run

  Note that    sergio_matlab_chip_makegas3_42.sbatch 1      calls      clust_runXtopts_savegasN_file.m which reads in gN_ir_list.txt

  Not possible to call   clust_runXtopts_savegasN_file.sc    since it calls Paul clustcmd  that DNE anymore
  
4) Then edit      filelist_gN.m         so you can check which files of a particular gas have been made
      filelist_gN.m       output into gN_ir_listN.txt      into individual T/wn job array IDs so you run clust_runXtopts_savegasN_file 
                          outout into gN_ir_listN_T11.txt  into T11 chunks so you can call    so you run clust_runXtopts_savegasN_file_11T
			  
   ie edit these out and call cder_home   
     %cd /home/sergio/HITRAN2UMBCLBL/MAKEIR/H2016/MAKEIR_ALL_H16/
     %cd /home/sergio/HITRAN2UMBCLBL/MAKEIR/H2020/MAKEIR_ALL_H20/
     cd /home/sergio/HITRAN2UMBCLBL/MAKEIR/H2024/MAKEIR_ALL_H24/     
   and once it tells you haw many chunks do not have 11 T offset files eg 25 out of 90, you can do
      sbatch --array=1-Nall --exclude c24-13  sergio_matlab_chip_makegas3_42.sbatch   (assuming you get processors, need many of those)   
      sbatch --array=1-N11  --exclude c24-13  sergio_matlab_chip_makegas3_42.sbatch 2 (assuming you get processors, need about Nall/11)

  filelist_xsecN.m    output into gN_ir_xseclist.txtN  whichever gasID you are trying to figure out if completely or partially made

5) When there are NO MORE JOBS running,
   you can check ALLLLLLLL GASESES by running      loop_rmerxN.m to              get rid of empty files
   THEN                                   Run      loop_filelist_gN_missing.m    when you want to see what is missing and needs to be run << deleting empty files >>
<< very importantly, makes   jobs_not_done.sc  >>
<<    so you can very easily checks which files have been run and just run the jobs you need to complete all files, >>
<<    rather than all 990 jobs submitted >>

6) IF CLUSTER IS FINE,
   the smart way is to run    loop_filelist_gN_missing.m     ... it can do everything
   
   IF CLUSTER IS STUCK
   the smart way is to run    loop_filelist_gN_missing.m     and     filelist_gN.m
   first run  loop_filelist_gN_missing.m to see which gases have not completed
   then rerun loop_filelist_gN_missing.m to zoom into a region of gases where things are not done (eg 10-20) .. or just zoom into Figure 4 of first run
   Suppose gases 10,14,15,18,19 are not done
     So run filelist_gN.m for g10, open file ugh and cp   gN_ir_listN_T11.txt   into it
     So run filelist_gN.m for g14, open file ugh and add  gN_ir_listN_T11.txt   into it
     So run filelist_gN.m for g15, open file ugh and add  gN_ir_listN_T11.txt   into it
     So run filelist_gN.m for g18, open file ugh and add  gN_ir_listN_T11.txt   into it
     So run filelist_gN.m for g19, open file ugh and add  gN_ir_listN_T11.txt   into it
   See how many total jobs NX need to run
   Then      cp ugh gN_ir_listN_T11.txt      and do    sbatch --array=1-NX --exclude c24-13  sergio_matlab_chip_makegas3_42.sbatch 2

%%%%%%%%%%%%%%%%%%%%%%%%%  
-rw-rw-r-- 1 sergio pi_strow  2957 Nov 14 16:50 loop_filelist_gN_missing.m   --- makes a list od missing files for next run trhough of
                                                                                 clust_runXtopts_savegasN_file.m/sergio_matlab_makegas3_42.sbatch
-rw-r--r-- 1 sergio pi_strow  1182 Nov 15 12:56 loop_rmerxN.m										 
-rw-r--r-- 1 sergio pi_strow   3546 Nov 13 19:06 loop_gas_done_already.m
-rw-r--r-- 1 sergio pi_strow  10153 Nov 13 19:05 gas_done_already.m
-rw-rw-r-- 1 sergio pi_strow    994 Nov 13 18:30 sergio_matlab_makegas3_42.sbatch
-rw-r--r-- 1 sergio pi_strow   2456 Nov 13 18:25 clust_runXtopts_savegasN_file.m
-rwxr-xr-x 1 sergio pi_strow    156 Nov 13 18:10 clust_runXtopts_savegasN_file.sc
-rw-rw-r-- 1 sergio pi_strow 213510 Nov 13 18:08 gN_ir_list.txt
-rw-r--r-- 1 sergio pi_strow   1919 Nov 13 18:06 loop_filelist_gN.m
-rw-r--r-- 1 sergio pi_strow    543 Nov 13 17:17 freq_boundaries.m

freq_boundaries.m -- set up the dirs I want to save to
           dirout = ['/asl/s1/sergio/H2020_RUN8_NIRDATABASE/IR_605_2830/g' num2str(gid) '.dat'];
loop_filelist_gN.m -- make the looooog list of ~20000 gas x freqchunk x 11 Toffsets to be done
           gN_ir_list.txt is from the above (assumes NOTHING has been done)
loop_filelist_gN_missing.m -- make the looooog list of ~20000 gas x freqchunk x 11 Toffsets to be done 
           gN_ir_list2.txt is from the above (assumes SOME have been done)
clust_runXtopts_savegasN_file.m : change the JOB from slurm so it makes sense
  gasIDlist = load('gN_ir_list.txt');
  XJOB = num2str(gasIDlist(JOB));
  if length(XJOB) == 8
    XJOB = ['0' num2str(gasIDlist(JOB))];
  end

sergio_matlab_chip_makegas3_42.sbatch : calls the matlab source code "clust_runXtopts_savegasN_file.m"
gas_done_already.m                    : included if iWhichFreqBoundaries == 2020 (edit file as needed)
loop_gas_done_already.m               : 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
GASES 51-81

loop_filelist_xsecN.m

edit loop_filelist_xsecN.m : change 2012 to 2016 to 2020
  /home/sergio/SPECTRA/READ_XSEC/read_xsec.m : need to fix that so default = 2016

sergio_matlab_makegas51_81.sbatch : calls clust_runXtopts_savexsecN_file

Note : have to be careful about iSwitchXsecDataBase
  originally I used the H12 xsec database so did nothing
  then I downloaded H2016 for gases 51-63, so had     to switch to H2012 for gases 64-81
  now  I downloaded H2016 for gases 51-81, so no need to switch to H2012

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
PUTTING CHUNKS TOGETHER

-rw-r--r-- 1 sergio pi_strow 3462 Nov 23 02:52 clust_runXtopts_mkgNvfiles.m
edit that so that you run it ONCE to make /asl/s1/sergio/H2016_RUN8_NIRDATABASE/IR_605_2830/abs.dat/
then edit sergio_matlab_makegas3_42.sbatch so that you use short queue, and call it as
   sbatch --array=1-49 sergio_matlab_makegas3_42.sbatch

it should fail on three gases that are not made by clust_runXtopts_savegasN_file.m
[sergio@maya-usr1 MAKEIR_ALL_H16]$ grep -in error slurm-6515106_*
slurm-6515106_34.out:37:Error in clust_runXtopts_mkgNvfiles (line 99)
slurm-6515106_37.out:37:Error in clust_runXtopts_mkgNvfiles (line 99)
slurm-6515106_48.out:37:Error in clust_runXtopts_mkgNvfiles (line 99)
[sergio@maya-usr1 MAKEIR_ALL_H16]$ ls -lt /asl/s1/sergio/H2016_RUN8_NIRDATABASE/IR_605_2830/g34.dat/
total 0
[sergio@maya-usr1 MAKEIR_ALL_H16]$ ls -lt /asl/s1/sergio/H2016_RUN8_NIRDATABASE/IR_605_2830/g37.dat/
total 0
[sergio@maya-usr1 MAKEIR_ALL_H16]$ ls -lt /asl/s1/sergio/H2016_RUN8_NIRDATABASE/IR_605_2830/g48.dat/
total 0

grep -in small slurm-6515106_* | more
  tells you which chunks did not have enough files

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
COMPRESS
cd /home/sergio/HITRAN2UMBCLBL/CMPRUN
edit cmprunIR_OTHERS.m as needed  H2012 --> H2016 --> H2020
  cmprunIR_OTHERS(3:42,605:25:2830,2020);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
CONVERT TO F77 files
cd /home/sergio/HITRAN2UMBCLBL/fortran/mat2for
edit loop_mat2forIR.m
  H2012 --> H2016 --> H2020

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
then you need to get the list of files ready for kCARTA
ls -lt /asl/data/kcarta/H2020.ieee-le/IR605/hdo.ieee-le/
ls -lt /asl/data/kcarta/H2020.ieee-le/IR605/etc.ieee-le/

cd /home/sergio/KCARTA/SCRIPTS/MAKE_COMP_HTXY_PARAM_SC
edit comp_IRdatabase_H2020.sc
  edit kWaterPath
       kCO2Path
       kCOmpPath
       PARAM_HT2020/comp_ir605_2830.param
run comp_IRdatabase_H2020.sc

>>>>>>>>>>>>>
NOTE : Nov 2017 been a bit lazy with XSC gases so use this script to copy or blow away xsc files
copy_xscHT2012_to_HT2020.sc   which contains these two simple lines
  cp -a /asl/data/kcarta/H2012_IR/etc/*g[5678][123456789].dat /asl/data/kcarta/H2020.ieee-le/IR605/etc.ieee-le/.
  cp -a /asl/data/kcarta/H2012_IR/etc/*g[678][0].dat /asl/data/kcarta/H2020.ieee-le/IR605/etc.ieee-le/.
>>>>>>>>>>>>>

then with Matlab you can run eg
  compare_databases(1:81,'PARAM_HT2012/comp_ir605_2830.param','PARAM_HT2020/comp_ir605_2830.param')
